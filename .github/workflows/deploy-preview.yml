name: Deploy (preview)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag to deploy (e.g. feature branch)"
        required: true
        default: "base44-reset"
      pr_number:
        description: "Optional PR number (for logging)"
        required: false

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    environment:
      name: preview

    steps:
      - name: "Info"
        run: echo "Deploying ${{ github.event.inputs.ref }} to preview (PR=${{ github.event.inputs.pr_number || 'n/a' }})"

      - name: "Guard: required preview secrets"
        env:
          A: ${{ secrets.PREVIEW_SSH_PRIVATE_KEY }}
          B: ${{ secrets.PREVIEW_DEPLOY_HOST }}
          C: ${{ secrets.PREVIEW_SSH_PORT }}
          D: ${{ secrets.PREVIEW_DEPLOY_USER }}
          E: ${{ secrets.PREVIEW_APP_DIR }}
        run: |
          [ -n "$A" ] || { echo "::error::PREVIEW_SSH_PRIVATE_KEY is empty"; exit 1; }
          [ -n "$B" ] || { echo "::error::PREVIEW_DEPLOY_HOST is empty"; exit 1; }
          [ -n "$C" ] || { echo "::error::PREVIEW_SSH_PORT is empty"; exit 1; }
          [ -n "$D" ] || { echo "::error::PREVIEW_DEPLOY_USER is empty"; exit 1; }
          [ -n "$E" ] || { echo "::error::PREVIEW_APP_DIR is empty"; exit 1; }

      - name: "Install SSH key (no agent)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PREVIEW_SSH_PRIVATE_KEY }}
          DEPLOY_HOST:     ${{ secrets.PREVIEW_DEPLOY_HOST }}
          SSH_PORT:        ${{ secrets.PREVIEW_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          umask 177
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: "Trigger server deploy (preview)"
        env:
          DEPLOY_USER: ${{ secrets.PREVIEW_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PREVIEW_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.PREVIEW_SSH_PORT }}
          APP_DIR:     ${{ secrets.PREVIEW_APP_DIR }}
          REF:         ${{ github.event.inputs.ref || github.ref_name }}
          PR_NUMBER:   ${{ github.event.inputs.pr_number }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          if [ -n "$SSH_PORT" ]; then SSH_OPTS="$SSH_OPTS -p $SSH_PORT"; fi
          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" \
            "BRANCH='$REF' APP_DIR='$APP_DIR' ONLY=preview PR_NUMBER='${PR_NUMBER}' /opt/summitcare/deploy.sh"
