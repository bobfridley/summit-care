name: Deploy (preview PR)
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Resolve secrets and set defaults
        id: vars
        env:
          DEPLOY_HOST: ${{ secrets.PREVIEW_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.PREVIEW_DEPLOY_USER }}
          SSH_PORT: ${{ secrets.PREVIEW_SSH_PORT }}
          APP_DIR: ${{ secrets.PREVIEW_APP_DIR }}
        run: |
          set -e
          for v in DEPLOY_HOST DEPLOY_USER APP_DIR; do
            if [ -z "${!v}" ]; then echo "::error::$v is empty"; exit 1; fi
          done
          PORT="${SSH_PORT:-22}"
          echo "host=$DEPLOY_HOST" >> $GITHUB_OUTPUT
          echo "user=$DEPLOY_USER" >> $GITHUB_OUTPUT
          echo "port=$PORT"        >> $GITHUB_OUTPUT
          echo "app_dir=$APP_DIR"  >> $GITHUB_OUTPUT

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          if [ "${{ steps.vars.outputs.port }}" != "22" ]; then
            ssh-keyscan -T 5 -p "${{ steps.vars.outputs.port }}" "${{ steps.vars.outputs.host }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "${{ steps.vars.outputs.host }}" >> ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

      - name: SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PREVIEW_SSH_PRIVATE_KEY }}

      # Recommended: call your server deploy script
      - name: Trigger server deploy (preview)
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "${{ steps.vars.outputs.port }}" != "22" ]; then
            ssh -o StrictHostKeyChecking=yes -o BatchMode=yes -p "${{ steps.vars.outputs.port }}" \
              "${{ steps.vars.outputs.user }}@${{ steps.vars.outputs.host }}" \
              "sudo -iu summitcare bash -lc 'PR_NUMBER=${PR_NUMBER} ONLY=preview APP_DIR=\"${{ steps.vars.outputs.app_dir }}\" /opt/summitcare/deploy.sh'"
          else
            ssh -o StrictHostKeyChecking=yes -o BatchMode=yes \
              "${{ steps.vars.outputs.user }}@${{ steps.vars.outputs.host }}" \
              "sudo -iu summitcare bash -lc 'PR_NUMBER=${PR_NUMBER} ONLY=preview APP_DIR=\"${{ steps.vars.outputs.app_dir }}\" /opt/summitcare/deploy.sh'"
          fi
