name: Deploy (production)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag to deploy"
        required: true
        default: "main"

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Install SSH key (no agent)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          DEPLOY_HOST:     ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:        ${{ secrets.PROD_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          umask 177
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Trigger server deploy (production)
        env:
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.PROD_SSH_PORT }}
          APP_DIR:     ${{ secrets.PROD_APP_DIR }}     # e.g. /var/www/summit-care
          REF:         ${{ github.event.inputs.ref }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          if [ -n "$SSH_PORT" ]; then SSH_OPTS="$SSH_OPTS -p $SSH_PORT"; fi

          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" \
            "BRANCH='$REF' APP_DIR='$APP_DIR' ONLY=prod /opt/summitcare/deploy.sh"
