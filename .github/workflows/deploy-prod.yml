name: Deploy (prod)
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or commit SHA) to deploy'
        required: false
        default: 'main'
  push:
    branches: [main]

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Resolve secrets and set defaults
        id: vars
        env:
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
          APP_DIR: ${{ secrets.PROD_APP_DIR }}
        run: |
          set -e
          for v in DEPLOY_HOST DEPLOY_USER APP_DIR; do
            if [ -z "${!v}" ]; then echo "::error::$v is empty"; exit 1; fi
          done
          PORT="${SSH_PORT:-22}"
          REF="${{ github.event.inputs.ref || 'main' }}"
          echo "host=$DEPLOY_HOST" >> $GITHUB_OUTPUT
          echo "user=$DEPLOY_USER" >> $GITHUB_OUTPUT
          echo "port=$PORT"        >> $GITHUB_OUTPUT
          echo "app_dir=$APP_DIR"  >> $GITHUB_OUTPUT
          echo "ref=$REF"          >> $GITHUB_OUTPUT

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          if [ "${{ steps.vars.outputs.port }}" != "22" ]; then
            ssh-keyscan -T 5 -p "${{ steps.vars.outputs.port }}" "${{ steps.vars.outputs.host }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "${{ steps.vars.outputs.host }}" >> ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

      - name: SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}

      # Recommended: call your server deploy script
      - name: Trigger server deploy (prod)
        run: |
          CMD="BRANCH='${{ steps.vars.outputs.ref }}' ONLY=prod APP_DIR='${{ steps.vars.outputs.app_dir }}' /opt/summitcare/deploy.sh"
          if [ "${{ steps.vars.outputs.port }}" != "22" ]; then
            ssh -o StrictHostKeyChecking=yes -o BatchMode=yes -p "${{ steps.vars.outputs.port }}" \
              "${{ steps.vars.outputs.user }}@${{ steps.vars.outputs.host }}" \
              "sudo -iu summitcare bash -lc \"$CMD\""
          else
            ssh -o StrictHostKeyChecking=yes -o BatchMode=yes \
              "${{ steps.vars.outputs.user }}@${{ steps.vars.outputs.host }}" \
              "sudo -iu summitcare bash -lc \"$CMD\""
          fi
