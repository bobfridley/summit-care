name: Deploy (production)

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag to deploy"
        required: true
        default: "main"

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: "Info"
        run: echo "Deploying ref '${{ github.event.inputs.ref || github.ref_name }}' to production"

      - name: "Guard: required prod secrets"
        env:
          A: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          B: ${{ secrets.PROD_DEPLOY_HOST }}
          C: ${{ secrets.PROD_SSH_PORT }}
          D: ${{ secrets.PROD_DEPLOY_USER }}
          E: ${{ secrets.PROD_APP_DIR }}
        run: |
          [ -n "$A" ] || { echo "::error::PROD_SSH_PRIVATE_KEY is empty"; exit 1; }
          [ -n "$B" ] || { echo "::error::PROD_DEPLOY_HOST is empty"; exit 1; }
          [ -n "$C" ] || { echo "::error::PROD_SSH_PORT is empty"; exit 1; }
          [ -n "$D" ] || { echo "::error::PROD_DEPLOY_USER is empty"; exit 1; }
          [ -n "$E" ] || { echo "::error::PROD_APP_DIR is empty"; exit 1; }

      - name: "Install SSH key (no agent)"
        env:
          SSH_PRIVATE_KEY_B64: ${{ secrets.PROD_SSH_PRIVATE_KEY_B64 }}
          DEPLOY_HOST:         ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:            ${{ secrets.PROD_SSH_PORT }}
        run: |
          set -e
          install -m 700 -d ~/.ssh
          umask 177
          echo "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keygen -lf ~/.ssh/id_deploy || { echo "::error::invalid private key"; exit 1; }
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: "Trigger server deploy (prod)"
        env:
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.PROD_SSH_PORT }}
          APP_DIR:     ${{ secrets.PROD_APP_DIR }}
          REF:         ${{ github.event.inputs.ref || github.ref_name }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          if [ -n "$SSH_PORT" ]; then SSH_OPTS="$SSH_OPTS -p $SSH_PORT"; fi
          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" \
            "REF='$REF' APP_DIR='$APP_DIR' ONLY=prod /opt/summitcare/deploy.sh"
