name: Deploy Check

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to check (staging | production | preview)"
        required: true
        default: "staging"

jobs:
  check-staging:
    if: ${{ github.event.inputs.env == 'staging' }}
    runs-on: ubuntu-latest
    environment:
      name: staging

    steps:
      - name: "Info"
        run: echo "Running deploy check for staging"

      - name: "Guard: required staging secrets"
        env:
          A: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          B: ${{ secrets.STAGING_DEPLOY_HOST }}
          C: ${{ secrets.STAGING_SSH_PORT }}
          D: ${{ secrets.STAGING_DEPLOY_USER }}
          E: ${{ secrets.STAGING_APP_DIR }}
        run: |
          [ -n "$A" ] || { echo "::error::STAGING_SSH_PRIVATE_KEY is empty"; exit 1; }
          [ -n "$B" ] || { echo "::error::STAGING_DEPLOY_HOST is empty"; exit 1; }
          [ -n "$C" ] || { echo "::error::STAGING_SSH_PORT is empty"; exit 1; }
          [ -n "$D" ] || { echo "::error::STAGING_DEPLOY_USER is empty"; exit 1; }
          [ -n "$E" ] || { echo "::error::STAGING_APP_DIR is empty"; exit 1; }

      - name: "Install SSH key (no agent)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          DEPLOY_HOST:     ${{ secrets.STAGING_DEPLOY_HOST }}
          SSH_PORT:        ${{ secrets.STAGING_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          umask 177
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: "Check dist & asset via SSH"
        env:
          DEPLOY_USER: ${{ secrets.STAGING_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.STAGING_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.STAGING_SSH_PORT }}
          APP_DIR:     ${{ secrets.STAGING_APP_DIR }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          [ -n "$SSH_PORT" ] && SSH_OPTS="$SSH_OPTS -p $SSH_PORT"
          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            echo '==> Verifying build directory: $APP_DIR/dist-staging'
            test -f \"$APP_DIR/dist-staging/index.html\" && echo 'âœ“ index.html present' || (echo 'âŒ missing index.html' && exit 1)
            echo '==> Sampling first asset:'
            f=\$(ls -1 \"$APP_DIR/dist-staging/assets\" | head -n1) || true
            [ -n \"\$f\" ] && echo \"Found asset: \$f\" || (echo 'âŒ no assets found' && exit 1)
          "

      - name: "Curl through NGINX"
        run: |
          echo "ğŸ” Curling https://healthandhiking.com/summit-care-staging"
          curl -sI "https://healthandhiking.com/summit-care-staging" | head -n1 || true

  check-production:
    if: ${{ github.event.inputs.env == 'production' }}
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: "Info"
        run: echo "Running deploy check for production"

      - name: "Guard: required production secrets"
        env:
          A: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          B: ${{ secrets.PROD_DEPLOY_HOST }}
          C: ${{ secrets.PROD_SSH_PORT }}
          D: ${{ secrets.PROD_DEPLOY_USER }}
          E: ${{ secrets.PROD_APP_DIR }}
        run: |
          [ -n "$A" ] || { echo "::error::PROD_SSH_PRIVATE_KEY is empty"; exit 1; }
          [ -n "$B" ] || { echo "::error::PROD_DEPLOY_HOST is empty"; exit 1; }
          [ -n "$C" ] || { echo "::error::PROD_SSH_PORT is empty"; exit 1; }
          [ -n "$D" ] || { echo "::error::PROD_DEPLOY_USER is empty"; exit 1; }
          [ -n "$E" ] || { echo "::error::PROD_APP_DIR is empty"; exit 1; }

      - name: "Install SSH key (no agent)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          DEPLOY_HOST:     ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:        ${{ secrets.PROD_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          umask 177
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: "Check dist & asset via SSH"
        env:
          DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.PROD_SSH_PORT }}
          APP_DIR:     ${{ secrets.PROD_APP_DIR }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          [ -n "$SSH_PORT" ] && SSH_OPTS="$SSH_OPTS -p $SSH_PORT"
          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            echo '==> Verifying build directory: $APP_DIR/dist-prod'
            test -f \"$APP_DIR/dist-prod/index.html\" && echo 'âœ“ index.html present' || (echo 'âŒ missing index.html' && exit 1)
            echo '==> Sampling first asset:'
            f=\$(ls -1 \"$APP_DIR/dist-prod/assets\" | head -n1) || true
            [ -n \"\$f\" ] && echo \"Found asset: \$f\" || (echo 'âŒ no assets found' && exit 1)
          "

      - name: "Curl through NGINX"
        run: |
          echo "ğŸ” Curling https://healthandhiking.com/summit-care"
          curl -sI "https://healthandhiking.com/summit-care" | head -n1 || true

  check-preview:
    if: ${{ github.event.inputs.env == 'preview' }}
    runs-on: ubuntu-latest
    environment:
      name: preview

    steps:
      - name: "Info"
        run: echo "Running deploy check for preview"

      - name: "Guard: required preview secrets"
        env:
          A: ${{ secrets.PREVIEW_SSH_PRIVATE_KEY }}
          B: ${{ secrets.PREVIEW_DEPLOY_HOST }}
          C: ${{ secrets.PREVIEW_SSH_PORT }}
          D: ${{ secrets.PREVIEW_DEPLOY_USER }}
          E: ${{ secrets.PREVIEW_APP_DIR }}
        run: |
          [ -n "$A" ] || { echo "::error::PREVIEW_SSH_PRIVATE_KEY is empty"; exit 1; }
          [ -n "$B" ] || { echo "::error::PREVIEW_DEPLOY_HOST is empty"; exit 1; }
          [ -n "$C" ] || { echo "::error::PREVIEW_SSH_PORT is empty"; exit 1; }
          [ -n "$D" ] || { echo "::error::PREVIEW_DEPLOY_USER is empty"; exit 1; }
          [ -n "$E" ] || { echo "::error::PREVIEW_APP_DIR is empty"; exit 1; }

      - name: "Install SSH key (no agent)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PREVIEW_SSH_PRIVATE_KEY }}
          DEPLOY_HOST:     ${{ secrets.PREVIEW_DEPLOY_HOST }}
          SSH_PORT:        ${{ secrets.PREVIEW_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          umask 177
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          if [ -n "$SSH_PORT" ]; then
            ssh-keyscan -T 5 -p "$SSH_PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -T 5 "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: "Check dist & asset via SSH"
        env:
          DEPLOY_USER: ${{ secrets.PREVIEW_DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PREVIEW_DEPLOY_HOST }}
          SSH_PORT:    ${{ secrets.PREVIEW_SSH_PORT }}
          APP_DIR:     ${{ secrets.PREVIEW_APP_DIR }}
        run: |
          set -e
          SSH_OPTS="-o StrictHostKeyChecking=yes -o BatchMode=yes"
          [ -n "$SSH_PORT" ] && SSH_OPTS="$SSH_OPTS -p $SSH_PORT"
          ssh -i ~/.ssh/id_deploy $SSH_OPTS "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            echo '==> Verifying build directory: $APP_DIR/dist-preview'
            test -f \"$APP_DIR/dist-preview/index.html\" && echo 'âœ“ index.html present' || (echo 'âŒ missing index.html' && exit 1)
            echo '==> Sampling first asset:'
            f=\$(ls -1 \"$APP_DIR/dist-preview/assets\" | head -n1) || true
            [ -n \"\$f\" ] && echo \"Found asset: \$f\" || (echo 'âŒ no assets found' && exit 1)
          "

      - name: "Curl through NGINX"
        run: |
          echo "ğŸ” Curling https://healthandhiking.com/summit-care-preview"
          curl -sI "https://healthandhiking.com/summit-care-preview" | head -n1 || true
